"use strict";(self.webpackChunk=self.webpackChunk||[]).push([["460"],{4373:function(t,e,i){i.r(e),i.d(e,{ImageDraw:()=>a,default:()=>n});var s=i(2676),h=i(5271),l=i(9679);function a(t){let e=h.useRef(null),{src:i,height:a=450,children:n}=t,[o,r]=h.useState(),[d,c]=h.useState();return h.useEffect(()=>{let t=e.current;if(!i||!t)return;let s=t.clientWidth,h=t.clientHeight,l=new Image;l.src=i,l.onload=function(){if(l.width&&l.height){let t=s/h,e=l.width/l.height,i=s,a=h;e<t&&(i=e*h),e>t&&(a=s/e),c({height:a,width:i}),r({width:l.width,height:l.height})}}},[i]),(0,s.jsxs)("div",{ref:e,className:"image-draw",children:[(0,s.jsx)(l.E,{fit:"contain",src:i,style:{height:a}}),(0,s.jsx)("div",{className:"image-draw-content",children:o&&d&&(null==n?void 0:n(o,d))})]})}i(9126),i(2373);let n=a},7045:function(t,e,i){i.r(e),i.d(e,{default:()=>R});var s,h,l=i(2676),a=i(5271),n=i(833);class o{get type(){return this._type}get data(){return this._data}constructor(t,e,i={scaleX:1,scaleY:1}){(0,n._)(this,"_type",void 0),(0,n._)(this,"_data",void 0),(0,n._)(this,"options",void 0),(0,n._)(this,"ctx",void 0),this._type=null==t?void 0:t.type,this._data=null==t?void 0:t.data,this.options=i,this.ctx=e}}class r extends o{toJson(){let t=this.recover();return{type:this.type,data:{...t}}}constructor(t,e,i={scaleX:1,scaleY:1}){super(t,e,i)}}function d(t){return t&&"number"==typeof t.x&&"number"==typeof t.y&&"number"==typeof t.width&&"number"==typeof t.height}class c extends r{transform(){var t,e,i,s,h,l,a,n;return this._data={rect:{x:(null==(e=this.data)||null==(t=e.rect)?void 0:t.x)/this.options.scaleX,y:(null==(s=this.data)||null==(i=s.rect)?void 0:i.y)/this.options.scaleY,width:(null==(l=this.data)||null==(h=l.rect)?void 0:h.width)/this.options.scaleX,height:(null==(n=this.data)||null==(a=n.rect)?void 0:a.height)/this.options.scaleY}},this}recover(){var t,e,i,s,h,l,a,n;return{rect:{x:(null==(e=this.data)||null==(t=e.rect)?void 0:t.x)*this.options.scaleX,y:(null==(s=this.data)||null==(i=s.rect)?void 0:i.y)*this.options.scaleY,width:(null==(l=this.data)||null==(h=l.rect)?void 0:h.width)*this.options.scaleX,height:(null==(n=this.data)||null==(a=n.rect)?void 0:a.height)*this.options.scaleY}}}constructor(t,e,i){super(t,e,i)}}class u extends c{static create(t,e,i){return new u({type:"circle",data:{rect:t}},e,i)}_getKeyPoints(){var t;let e=null===this||void 0===this||null==(t=this.data)?void 0:t.rect;return[{x:(null==e?void 0:e.x)+(null==e?void 0:e.width)*.5,y:null==e?void 0:e.y},{x:(null==e?void 0:e.x)+(null==e?void 0:e.width),y:(null==e?void 0:e.y)+(null==e?void 0:e.height)*.5},{x:(null==e?void 0:e.x)+(null==e?void 0:e.width)*.5,y:(null==e?void 0:e.y)+(null==e?void 0:e.height)},{x:null==e?void 0:e.x,y:(null==e?void 0:e.y)+(null==e?void 0:e.height)*.5}]}_getCenterAndRadius(){var t;let e=null===this||void 0===this||null==(t=this.data)?void 0:t.rect,i={x:(null==e?void 0:e.x)+(null==e?void 0:e.width)*.5,y:(null==e?void 0:e.y)+(null==e?void 0:e.height)*.5};return{center:i,radiusX:Math.abs((null==e?void 0:e.width)*.5),radiusY:Math.abs((null==e?void 0:e.height)*.5)}}draw(t,e){var i;let s=this.ctx,h=null===this||void 0===this||null==(i=this.data)?void 0:i.rect;if(s&&h){let{center:i,radiusX:h,radiusY:l}=this._getCenterAndRadius();s.save(),s.fillStyle=null==t?void 0:t.fillStyle,s.lineWidth=null==t?void 0:t.lineWidth,s.strokeStyle=null==t?void 0:t.strokeStyle,s.setLineDash(e?[4,4]:[]),s.beginPath(),s.ellipse(i.x,i.y,h,l,0,0,2*Math.PI),s.stroke(),s.fill(),s.restore()}}drawActive(t,e){var i;let s=this.ctx,h=null===this||void 0===this||null==(i=this.data)?void 0:i.rect;if(s&&h){this.draw(this.options.activeShapeStyle,e),s.save();let i=this._getKeyPoints();(null==i?void 0:i.length)>0&&i.forEach((e,i)=>{var h,l,a;let n=i===t?(null==(h=this.options.activeShapeStyle)?void 0:h.circleRadius)+2:null==(l=this.options.activeShapeStyle)?void 0:l.circleRadius;s.fillStyle=null==(a=this.options.activeShapeStyle)?void 0:a.strokeStyle,s.strokeStyle="#FFF",s.lineWidth=1,s.beginPath(),s.arc(e.x,e.y,n,0,2*Math.PI,!0),s.fill(),s.beginPath(),s.arc(e.x,e.y,n,0,2*Math.PI),s.stroke()}),s.restore()}}drawWip(){this.drawActive(-1,!0)}}class p extends r{static create(t,e,i){return new p({type:"polygon",data:{points:t}},e,i)}draw(t){let e=this.ctx;if(e){e.save(),e.fillStyle=null==t?void 0:t.fillStyle,e.lineWidth=null==t?void 0:t.lineWidth,e.strokeStyle=null==t?void 0:t.strokeStyle;let i=this.data.points;(null==i?void 0:i.length)>0&&(e.beginPath(),e.setLineDash([]),e.moveTo(i[0].x,i[0].y),i.forEach((t,i)=>{i>0&&e.lineTo(t.x,t.y)}),e.closePath(),e.stroke(),e.fill()),e.restore()}}drawActive(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1,e=this.ctx;if(e){var i,s,h,l,a,n;this.draw(this.options.activeShapeStyle),e.save(),(null==(s=this.data)||null==(i=s.points)?void 0:i.length)>0&&(null==(a=this.data)||a.points.forEach((i,s)=>{var h,l,a;let n=s===t?(null==(h=this.options.activeShapeStyle)?void 0:h.circleRadius)+2:null==(l=this.options.activeShapeStyle)?void 0:l.circleRadius;e.fillStyle=null==(a=this.options.activeShapeStyle)?void 0:a.strokeStyle,e.strokeStyle="#FFF",e.lineWidth=1,e.setLineDash([]),e.beginPath(),e.arc(i.x,i.y,n,0,2*Math.PI,!0),e.fill(),e.beginPath(),e.arc(i.x,i.y,n,0,2*Math.PI),e.stroke()})),(null==(l=this.data)||null==(h=l.points)?void 0:h.length)>1&&(null==(n=this.data)||n.points.forEach((t,i)=>{var s,h,l;let a=null==(h=this.data)||null==(s=h.points)?void 0:s[(i+1)%this.data.points.length],n={x:(t.x+a.x)/2,y:(t.y+a.y)/2},o=null==(l=this.options.shapeStyle)?void 0:l.circleRadius;e.beginPath(),e.arc(n.x,n.y,o-1,0,2*Math.PI,!0),e.fill()})),e.restore()}}drawWip(){let t=this.ctx;if(t){var e,i,s,h,l,a;t.save(),t.fillStyle=null==(i=this.options)||null==(e=i.activeShapeStyle)?void 0:e.fillStyle,t.lineWidth=null==(h=this.options)||null==(s=h.activeShapeStyle)?void 0:s.lineWidth,t.strokeStyle=null==(a=this.options)||null==(l=a.activeShapeStyle)?void 0:l.strokeStyle;let n=this.data.points;if(n.length>2&&(t.beginPath(),t.setLineDash([]),t.moveTo(n[0].x,n[0].y),null==n||n.slice(0,n.length-1).forEach((e,i)=>{i>0&&t.lineTo(e.x,e.y)}),t.stroke(),t.fill()),n.length>1){t.beginPath(),t.setLineDash([4,4]);let e=n[n.length-1],i=n[0];if(t.moveTo(i.x,i.y),t.lineTo(e.x,e.y),n.length>2){let e=n[n.length-2];t.lineTo(e.x,e.y)}t.stroke()}if(t.restore(),t.save(),(null==n?void 0:n.length)>0){let e=n.length>1?n.length-2:0;null==n||n.slice(0,n.length-1).forEach((i,s)=>{var h,l,a,n;let o=null==(l=this.options)||null==(h=l.shapeStyle)?void 0:h.circleRadius,r=s===e?o+2:o;t.fillStyle=null==(n=this.options)||null==(a=n.activeShapeStyle)?void 0:a.strokeStyle,t.strokeStyle="#FFF",t.lineWidth=1,t.setLineDash([]),t.beginPath(),t.arc(i.x,i.y,r,0,2*Math.PI,!0),t.fill(),t.beginPath(),t.arc(i.x,i.y,r,0,2*Math.PI),t.stroke()})}t.restore()}}transform(){var t,e;return this._data={points:null==(e=this.data)||null==(t=e.points)?void 0:t.map(t=>({x:t.x/this.options.scaleX,y:t.y/this.options.scaleY}))},this}recover(){var t,e;return{points:null==(e=this.data)||null==(t=e.points)?void 0:t.map(t=>({x:Number.parseInt(String(t.x*this.options.scaleX),10),y:Number.parseInt(String(t.y*this.options.scaleY),10)}))}}constructor(t,e,i){(null==t?void 0:t.type)||(t.type="polygon",t.data=t),super(t,e,i)}}class v extends c{static create(t,e,i){return new v({type:"rectangle",data:{rect:t}},e,i)}draw(t,e){var i;let s=this.ctx,h=null===this||void 0===this||null==(i=this.data)?void 0:i.rect;s&&h&&(s.save(),s.fillStyle=null==t?void 0:t.fillStyle,s.lineWidth=null==t?void 0:t.lineWidth,s.strokeStyle=null==t?void 0:t.strokeStyle,s.setLineDash(e?[4,4]:[]),s.beginPath(),s.roundRect(h.x,h.y,h.width,h.height,0),s.fillRect(h.x,h.y,h.width,h.height),s.stroke(),s.restore())}drawActive(t,e){var i;let s=this.ctx,h=null===this||void 0===this||null==(i=this.data)?void 0:i.rect;if(s&&h){this.draw(this.options.activeShapeStyle,e),s.save();let i=[{x:h.x,y:h.y},{x:h.x+h.width,y:h.y},{x:h.x+h.width,y:h.y+h.height},{x:h.x,y:h.y+h.height}];(null==i?void 0:i.length)>0&&i.forEach((e,i)=>{var h,l,a;let n=i===t?(null==(h=this.options.activeShapeStyle)?void 0:h.circleRadius)+2:null==(l=this.options.activeShapeStyle)?void 0:l.circleRadius;s.fillStyle=null==(a=this.options.activeShapeStyle)?void 0:a.strokeStyle,s.strokeStyle="#FFF",s.lineWidth=1,s.setLineDash([]),s.beginPath(),s.arc(e.x,e.y,n,0,2*Math.PI,!0),s.fill(),s.beginPath(),s.arc(e.x,e.y,n,0,2*Math.PI),s.stroke()}),s.restore()}}drawWip(){this.drawActive(-1,!0)}}class y{static createShape(t,e,i){switch(t.type){case"polygon":default:return new p(t,e,i);case"rectangle":return new v(t,e,i);case"circle":return new u(t,e,i)}}static createShapes(t,e,i){return t.map(t=>y.createShape(t,e,i))}}var f=((s={})[s.None=-1]="None",s[s.KeyPoint=1]="KeyPoint",s[s.CenterPoint=2]="CenterPoint",s);class x{isPointInShapeKey(t,e,i){var s,h;let l=this.getShapeKeyPoints(e);if((null==l?void 0:l.length)<3&&!i)return[-1,-1];let a=(null==(h=this.options)||null==(s=h.shapeStyle)?void 0:s.circleRadius)+1;for(let e=0;e<l.length;++e){let i=l[e];if(Math.abs(t.x-i.x)**2+Math.abs(t.y-i.y)**2<=a**2)return[1,e];let s=null==l?void 0:l[(e+1)%l.length],h={x:(i.x+s.x)*.5,y:(i.y+s.y)*.5};if(Math.abs(t.x-h.x)**2+Math.abs(t.y-h.y)**2<=a**2)return[2,e]}return[-1,-1]}isPointInPath(t,e){return this.pen.ctx.clearRect(0,0,this.pen.width,this.pen.height),null==e?void 0:e.reduce((e,i,s)=>{this.pen.drawShape(y.createShape(i,this.pen.ctx,{...this.options,scaleX:1,scaleY:1}));let h=this.pen.physicalToCanvas(t);return this.pen.ctx.isPointInPath(h.x,h.y)&&e.push(s),e},[])}isPointInKeyPath(t,e){for(let i=0;i<e.length;++i){let s=e[i],[h,l]=this.isPointInShapeKey(t,s);if(-1!==h)return[i,h,l]}return!1}getShapeKeyPoints(t){var e,i,s;if((null==t?void 0:t.type)==="rectangle"){let i=null==t||null==(e=t.data)?void 0:e.rect;return[{x:null==i?void 0:i.x,y:null==i?void 0:i.y},{x:(null==i?void 0:i.x)+(null==i?void 0:i.width),y:null==i?void 0:i.y},{x:(null==i?void 0:i.x)+(null==i?void 0:i.width),y:(null==i?void 0:i.y)+(null==i?void 0:i.height)},{x:null==i?void 0:i.x,y:(null==i?void 0:i.y)+(null==i?void 0:i.height)}]}if((null==t?void 0:t.type)!=="circle")return(null==t||null==(s=t.data)?void 0:s.points)||[];{let e=null==t||null==(i=t.data)?void 0:i.rect;return[{x:(null==e?void 0:e.x)+(null==e?void 0:e.width)*.5,y:null==e?void 0:e.y},{x:(null==e?void 0:e.x)+(null==e?void 0:e.width),y:(null==e?void 0:e.y)+(null==e?void 0:e.height)*.5},{x:(null==e?void 0:e.x)+(null==e?void 0:e.width)*.5,y:(null==e?void 0:e.y)+(null==e?void 0:e.height)},{x:null==e?void 0:e.x,y:(null==e?void 0:e.y)+(null==e?void 0:e.height)*.5}]}}constructor(t,e){(0,n._)(this,"pen",void 0),(0,n._)(this,"options",void 0),this.pen=t,this.options=e}}class _{get ctx(){return this.canvas.getContext("2d")}get width(){return this._width}set width(t){this._width=t}get height(){return this._height}set height(t){this._height=t}get scaleX(){return this._scaleX}get scaleY(){return this._scaleY}constructor(t,e){var i=this;(0,n._)(this,"canvas",void 0),(0,n._)(this,"_scaleX",void 0),(0,n._)(this,"_scaleY",void 0),(0,n._)(this,"_width",void 0),(0,n._)(this,"_height",void 0),(0,n._)(this,"canvasWidth",void 0),(0,n._)(this,"canvasHeight",void 0),(0,n._)(this,"options",void 0),(0,n._)(this,"dpr",window.devicePixelRatio),(0,n._)(this,"_drawShapes",function(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1;t.forEach((t,i)=>{i!==e&&t.draw()}),(null==t?void 0:t[e])&&t[e].drawActive(i)}),(0,n._)(this,"drawShape",(t,e)=>{t.draw(e)}),(0,n._)(this,"physicalToCanvas",t=>({x:t.x*this.dpr,y:t.y*this.dpr})),(0,n._)(this,"draw",(t,e,i)=>{let s=this.ctx;s&&(s.clearRect(0,0,this.width,this.height),this._drawShapes(t,e),i&&-1===e&&i.drawWip())}),(0,n._)(this,"drawActive",function(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1,h=i.ctx;h&&(h.clearRect(0,0,i.width,i.height),i._drawShapes(t,e,s))}),(0,n._)(this,"_drawRoundRectPath",(t,e,i)=>{let s=this.ctx;s&&(s.beginPath(),s.arc(t-i,e-i,i,0,Math.PI/2),s.lineTo(i,e),s.arc(i,e-i,i,Math.PI/2,Math.PI),s.lineTo(0,i),s.arc(i,i,i,Math.PI,3*Math.PI/2),s.lineTo(t-i,0),s.arc(t-i,i,i,3*Math.PI/2,2*Math.PI),s.lineTo(t,e-i),s.closePath())}),(0,n._)(this,"drawTooltip",(t,e,i)=>{let s=this.ctx;if(s){s.save(),s.font="12px",s.textBaseline="top",s.fillStyle="#0D1014";let h=s.measureText(i).width+16,l=t+6,a=e+16,n=l,o=a;l+h>this.canvasWidth&&(n=t-h),a+24>this.canvasHeight&&(o=e-24),s.save(),s.translate(n,o),this._drawRoundRectPath(h,24,4),s.fillStyle="rgba(10, 27, 57, 0.8)",s.fill(),s.restore(),s.fillStyle="#fff",s.fillText(i,n+8,o+7),s.restore()}}),this.canvas=t;let s=this.canvas.getContext("2d"),{width:h,height:l,shapeStyle:a}=e;this.options=e,this._width=e.axis.width,this._height=e.axis.height,this._scaleX=e.axis.width/h,this._scaleY=e.axis.height/l;let o=this.canvas.clientWidth,r=this.canvas.clientHeight;this.canvasWidth=o,this.canvasHeight=r,s&&(this.canvas.style.width=`${h}px`,this.canvas.style.height=`${l}px`,this.canvas.width=this.dpr*o,this.canvas.height=this.dpr*r,s.fillStyle=null==a?void 0:a.fillStyle,s.lineWidth=null==a?void 0:a.lineWidth,s.strokeStyle=null==a?void 0:a.strokeStyle,s.scale(this.dpr,this.dpr),s.clearRect(0,0,t.width,t.height))}}class w{off(t){if(t){let e=this.listeners.indexOf(t);e>-1&&this.listeners.splice(e,1)}return this}clear(){this.listeners=[]}constructor(){(0,n._)(this,"listeners",[]),(0,n._)(this,"on",t=>(t&&-1===this.listeners.indexOf(t)&&this.listeners.push(t),this)),(0,n._)(this,"_dispatch",t=>this.listeners.forEach(e=>e((null==t?void 0:t.map(t=>t.toJson()))??[])))}}class g{constructor(){(0,n._)(this,"activeShapeIndex",-1),(0,n._)(this,"shapes",[])}}class S extends w{get shapes(){return this.operatorState.shapes}set shapes(t){this.operatorState.shapes=t}get options(){return this._options}get canvas(){return this._canvas}get pen(){return this._pen}get measurer(){return this._measurer}get activeShapeIndex(){return this.operatorState.activeShapeIndex}set activeShapeIndex(t){this.operatorState.activeShapeIndex=t}attach(){return this}enable(){this._isEnabled=!0}disable(){this._isEnabled=!1}createShapes(t){return y.createShapes(t,this.pen.ctx,{...this.options,scaleX:this.pen.scaleX,scaleY:this.pen.scaleY})}select(t){var e,i;this.activeShapeIndex=t,this.pen.draw(this.shapes,t),null===this||void 0===this||null==(i=this.options)||null==(e=i.onSelect)||e.call(i,t)}updateShapes(t){var e;this.operatorState.shapes=null==(e=this.createShapes(t))?void 0:e.map(t=>t.transform()),this.pen.draw(this.shapes,this.activeShapeIndex)}destroy(){this.clear(),this.canvas.oncontextmenu=null}dispatch(){this._dispatch(this.shapes)}constructor(t,e,i,s){var h,l;super(),(0,n._)(this,"_canvas",void 0),(0,n._)(this,"_options",void 0),(0,n._)(this,"operatorState",void 0),(0,n._)(this,"_pen",void 0),(0,n._)(this,"_measurer",void 0),(0,n._)(this,"_isEnabled",!0),(0,n._)(this,"_createControlledListener",t=>e=>{var i,s,h,l,a,n,o,r;let d="edit"===this.options.mode,c=!1;(null==(i=this.options)?void 0:i.subOperator)?(null===this||void 0===this||null==(h=this.shapes)||null==(s=h[this.activeShapeIndex])?void 0:s.type)===(null==(l=this.options)?void 0:l.shape)&&(c=!0):(null===this||void 0===this||null==(a=this.shapes)?void 0:a[this.activeShapeIndex])&&(null===this||void 0===this||null==(o=this.shapes)||null==(n=o[this.activeShapeIndex])?void 0:n.type)!==(null==(r=this.options)?void 0:r.shape)||(c=!0),d&&this._isEnabled&&c&&t(e)}),this._canvas=t,this._options=s,this._pen=new _(t,s),this._measurer=new x(this._pen,s),this.operatorState=i,this.operatorState.shapes=null==(h=this.createShapes(e))?void 0:h.map(t=>t.transform()),(null==(l=this.shapes)?void 0:l.length)>0&&this.pen.draw(this.shapes,this.activeShapeIndex),t.oncontextmenu=t=>{t.preventDefault()}}}class m extends S{destroy(){"select"===this.options.mode&&(this.canvas.removeEventListener("mousemove",this._handleMouseMove,!1),this.canvas.removeEventListener("click",this._handleClick,!1),this.canvas.removeEventListener("mouseleave",this._handleMouseLeave,!1))}select(t){var e,i;this.activeShapeIndex=t,this._drawShapes(this.shapes,this.activeShapeIndex),null==(e=(i=this.options).onSelect)||e.call(i,t)}_drawShapes(t,e){this.pen.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),t.forEach((t,i)=>{i!==e&&this.pen.drawShape(t,this.options.shapeStyle)}),(null==t?void 0:t[e])&&this.pen.drawShape(null==t?void 0:t[e],this.options.activeShapeStyle)}constructor(t,e,i,s){super(t,e,i,s),(0,n._)(this,"_handleMouseLeave",()=>{this._drawShapes(this.shapes,this.activeShapeIndex)}),(0,n._)(this,"_handleClick",t=>{if(this.pen){let e=this.measurer.isPointInPath({x:t.offsetX,y:t.offsetY},this.shapes);e.length>0?this.activeShapeIndex===e[0]?this.select(-1):this.select(e[0]):this.select(this.activeShapeIndex)}}),(0,n._)(this,"_handleMouseMove",t=>{if(this.pen){let e=this.measurer.isPointInPath({x:t.offsetX,y:t.offsetY},this.shapes);e.length>0?(this.canvas.style.cursor="pointer",this._drawShapes(this.shapes,this.activeShapeIndex),this.pen.drawTooltip(t.offsetX,t.offsetY,e[0]===this.activeShapeIndex?"单击面取消选中":"单击面可选中")):(this.canvas.style.cursor="default",this._drawShapes(this.shapes,this.activeShapeIndex))}}),"select"===this.options.mode&&(t.addEventListener("mousemove",this._handleMouseMove,!1),t.addEventListener("click",this._handleClick,!1),t.addEventListener("mouseleave",this._handleMouseLeave,!1))}}var P=((h={})[h.Drawing=0]="Drawing",h[h.Editing=1]="Editing",h[h.Idle=2]="Idle",h[h.Resize=3]="Resize",h[h.Pan=4]="Pan",h);class E extends S{destroy(){"edit"===this.options.mode&&(this.canvas.removeEventListener("mousedown",this._handleMousedown,!1),this.canvas.removeEventListener("mouseup",this._handleMouseup,!1),this.canvas.removeEventListener("mousemove",this._handleMouseMove,!1),this.canvas.removeEventListener("click",this._handleClick,!1),this.canvas.removeEventListener("dblclick",this._handleDblClick,!1),document.removeEventListener("keydown",this._handleKeydown,!1),document.removeEventListener("click",this._handleDocumentClick,!1),this.canvas.removeEventListener("mouseleave",this._handleMouseLeave,!1))}select(t){super.select(t),this.state=t>-1?P.Editing:P.Idle}_complete(){if(d(this.wipRect)){let t=this._createShape(this.wipRect);t&&(this.shapes.push(t),this.wipRect={},this.select(this.shapes.length-1),this.dispatch())}}constructor(t,e,i,s){super(t,e,i,s),(0,n._)(this,"state",P.Idle),(0,n._)(this,"resizeHandle",-1),(0,n._)(this,"wipRect",{}),(0,n._)(this,"_handleMouseLeave",this._createControlledListener(t=>{this._handleMouseMove(t)})),(0,n._)(this,"_handleDocumentClick",this._createControlledListener(t=>{(null==t?void 0:t.target)!==this.canvas&&this.state===P.Editing&&this.select(-1)})),(0,n._)(this,"_handleKeydown",this._createControlledListener(t=>{if("Backspace"===t.code||"Delete"===t.code)if(this.state===P.Editing){var e;(null==(e=this.shapes)?void 0:e[this.activeShapeIndex])&&(this.shapes.splice(this.activeShapeIndex,1),this.dispatch(),this.select(-1))}else this.state===P.Drawing&&(this.wipRect={},this.select(-1))})),(0,n._)(this,"_handleMousedown",this._createControlledListener(t=>{if(2===t.button)this.state===P.Drawing&&(this.state=P.Idle,this._complete());else{var e;let i=null==(e=this.shapes)?void 0:e[this.activeShapeIndex],s=this.measurer.isPointInShapeKey({x:t.offsetX,y:t.offsetY},i);if(s){let[t,e]=s;t===f.KeyPoint&&(this.state=P.Resize,this.resizeHandle=e)}}})),(0,n._)(this,"_handleMouseup",this._createControlledListener(()=>{this.state===P.Resize&&this.dispatch()})),(0,n._)(this,"resizeShape",(t,e,i)=>{if("rectangle"===t.type){let s=this.measurer.getShapeKeyPoints(t);4===s.length&&-1!==i&&(0===i?t.data.rect={x:e.x,y:e.y,width:s[2].x-e.x,height:s[2].y-e.y}:1===i?t.data.rect={x:s[0].x,y:e.y,width:e.x-s[0].x,height:s[2].y-e.y}:2===i?t.data.rect={x:s[0].x,y:s[0].y,width:e.x-s[0].x,height:e.y-s[0].y}:3===i&&(t.data.rect={x:e.x,y:s[0].y,width:s[2].x-e.x,height:e.y-s[0].y}))}}),(0,n._)(this,"_handleMouseMove",this._createControlledListener(t=>{var e,i,s,h,l,a,n;if(this.state===P.Drawing){if("number"==typeof(null===this||void 0===this||null==(e=this.wipRect)?void 0:e.x)&&"number"==typeof(null===this||void 0===this||null==(i=this.wipRect)?void 0:i.y)){let e=t.offsetX-this.wipRect.x,i=t.offsetY-this.wipRect.y;if(this.wipRect.width=e,this.wipRect.height=i,d(this.wipRect)){let e=this._createShape(this.wipRect);e&&(this.pen.draw(this.shapes,-1,e),this.canvas.style.cursor="crosshair",this.pen.drawTooltip(t.offsetX,t.offsetY,"双击或右键结束"))}}}else if(this.state===P.Idle){let e=this.measurer.isPointInPath({x:t.offsetX,y:t.offsetY},this.shapes);this.shapes.length<this.options.editableMaxSize&&0===e.length?(this.pen.drawTooltip(t.offsetX,t.offsetY,"单击绘制起点"),this.canvas.style.cursor="crosshair"):e.length>0?(this.canvas.style.cursor="pointer",this.pen.drawTooltip(t.offsetX,t.offsetY,"单击面可选中并编辑，删除")):(this.canvas.style.cursor="not-allowed",this.pen.drawTooltip(t.offsetX,t.offsetY,`\u{7ED8}\u{5236}\u{6570}\u{91CF}\u{5DF2}\u{8FBE}\u{4E0A}\u{9650}${this.options.editableMaxSize}\u{4E2A}\u{FF0C}\u{4E0D}\u{80FD}\u{7EE7}\u{7EED}\u{7ED8}\u{5236}`))}else if(this.state===P.Resize){let e=null==(s=this.shapes)?void 0:s[this.activeShapeIndex];e&&-1!==this.resizeHandle&&(this.resizeShape(e,{x:t.offsetX,y:t.offsetY},this.resizeHandle),this.pen.draw(this.shapes,this.activeShapeIndex),this.canvas.style.cursor="move")}else if(this.state===P.Editing){let e=null==(h=this.shapes)?void 0:h[this.activeShapeIndex];if(e){this.pen.draw(this.shapes,this.activeShapeIndex);let i=this.measurer.isPointInShapeKey({x:t.offsetX,y:t.offsetY},e);(null==i?void 0:i[0])===f.KeyPoint?(this.canvas.style.cursor="pointer",this.pen.drawActive(this.shapes,this.activeShapeIndex,i[1]),this.pen.drawTooltip(t.offsetX,t.offsetY,`\u{62D6}\u{62FD}\u{8282}\u{70B9}\u{8C03}\u{6574}\u{4F4D}\u{7F6E}${(null==e||null==(a=e.data)||null==(l=a.points)?void 0:l.length)>(null==(n=this.options)?void 0:n.minPoint)?"，右键删除":""}`)):this.canvas.style.cursor="default"}}})),(0,n._)(this,"_handleClick",this._createControlledListener(t=>{if(this.pen)if(this.state!==P.Resize&&this.state!==P.Pan&&this.state!==P.Drawing){let e=this.measurer.isPointInPath({x:t.offsetX,y:t.offsetY},this.shapes);e.length>0?(this.state===P.Idle||this.state===P.Editing)&&this.select(e[0]):(this.state===P.Idle||this.state===P.Editing)&&this.shapes.length<this.options.editableMaxSize?(this.wipRect={x:t.offsetX,y:t.offsetY,width:0,height:0},this.pen.draw(this.shapes,-1,this._createShape(this.wipRect)),this.canvas.style.cursor="crosshair",this.pen.drawTooltip(t.offsetX,t.offsetY,"双击或右键结束"),this.state=P.Drawing):this.state===P.Editing&&this.shapes.length>=this.options.editableMaxSize&&(this.select(-1),this.state=P.Idle)}else this.state===P.Resize&&(this.state=P.Editing)})),(0,n._)(this,"_handleDblClick",this._createControlledListener(()=>{this.state===P.Drawing&&this._complete()})),(0,n._)(this,"_createShape",t=>{let e=this.options.shape;return"rectangle"===e?v.create(t,this.pen.ctx,{...this.options,scaleX:this.pen.scaleX,scaleY:this.pen.scaleY}):"circle"===e?u.create(t,this.pen.ctx,{...this.options,scaleX:this.pen.scaleX,scaleY:this.pen.scaleY}):null}),"edit"===this.options.mode&&(t.addEventListener("mousedown",this._handleMousedown,!1),t.addEventListener("mouseup",this._handleMouseup,!1),t.addEventListener("mousemove",this._handleMouseMove,!1),t.addEventListener("click",this._handleClick,!1),t.addEventListener("dblclick",this._handleDblClick,!1),document.addEventListener("keydown",this._handleKeydown,!1),document.addEventListener("click",this._handleDocumentClick,!1),t.addEventListener("mouseleave",this._handleMouseLeave,!1))}}let I={rectangle:E,polygon:class extends S{select(t){super.select(t),this.state=t>-1?1:2}destroy(){let t=this.canvas;t.removeEventListener("mousemove",this._handleMouseMove,!1),t.removeEventListener("click",this._handleClick,!1),t.removeEventListener("dblclick",this._handleDblclick,!1),t.removeEventListener("mousedown",this._handleMousedown,!1),t.removeEventListener("mouseup",this._handleMouseup,!1),document.removeEventListener("keydown",this._handleKeydown,!1),document.removeEventListener("click",this._handleDocumentClick,!1),t.removeEventListener("mouseleave",this._handleMouseLeave,!1),this.clear()}_complete(){this.shapes.push(this._createShape(this.wipPoints)),this.wipPoints=[],this.select(this.shapes.length-1),this.dispatch()}constructor(t,e,i,s){super(t,e,i,s),(0,n._)(this,"resizeHandle",-1),(0,n._)(this,"wipPoints",[]),(0,n._)(this,"state",2),(0,n._)(this,"updateShapes",t=>{var e;this.shapes=null==(e=y.createShapes(t,this.pen.ctx,{...this.options,scaleX:this.pen.scaleX,scaleY:this.pen.scaleY}))?void 0:e.map(t=>null==t?void 0:t.transform()),this.pen.draw(this.shapes,this.activeShapeIndex),t&&(null==t?void 0:t.length)!==0||(this.state=2)}),(0,n._)(this,"_createShape",t=>p.create(t,this.pen.ctx,{...this.options,scaleX:this.pen.scaleX,scaleY:this.pen.scaleY})),(0,n._)(this,"_handleMouseLeave",this._createControlledListener(t=>{var e;this.pen.draw(this.shapes,this.activeShapeIndex,this._createShape((null==(e=this.wipPoints)?void 0:e.concat({x:t.offsetX,y:t.offsetY}))||[]))})),(0,n._)(this,"_handleDocumentClick",this._createControlledListener(t=>{(null==t?void 0:t.target)!==this.canvas&&1===this.state&&this.select(-1)})),(0,n._)(this,"_handleKeydown",this._createControlledListener(t=>{if("Backspace"===t.code||"Delete"===t.code){var e,i;1===this.state?(null==(e=this.shapes)?void 0:e[this.activeShapeIndex])&&(this.shapes.splice(this.activeShapeIndex,1),this.dispatch(),this.select(-1)):0===this.state&&(null==(i=this.wipPoints)?void 0:i.length)>=this.options.minPoint-1&&(this.wipPoints=[],this.select(-1))}})),(0,n._)(this,"_handleMousedown",this._createControlledListener(t=>{var e,i,s,h,l,a,n,o,r,d,c,u,p,v;let y=null==(e=this.shapes)?void 0:e[this.activeShapeIndex];if(1===this.state&&y){let e=this.measurer.isPointInShapeKey({x:t.offsetX,y:t.offsetY},y);if(e){let[x,_]=e;if(x===f.KeyPoint)2===t.button?(null==y||null==(s=y.data)||null==(i=s.points)?void 0:i.length)>this.options.minPoint&&(null==y||null==(h=y.data)||h.points.splice(_,1),this.pen.draw(this.shapes,this.activeShapeIndex),this.dispatch()):(this.state=3,this.resizeHandle=_);else if(x===f.CenterPoint&&(null==y||null==(a=y.data)||null==(l=a.points)?void 0:l.length)<(null==(n=this.options)?void 0:n.maxPoint)){let t=null==y||null==(r=y.data)||null==(o=r.points)?void 0:o[_],e=null==y||null==(p=y.data)||null==(u=p.points)?void 0:u[(_+1)%(null==y||null==(c=y.data)||null==(d=c.points)?void 0:d.length)];if(t&&e){let i={x:(t.x+e.x)*.5,y:(t.y+e.y)*.5};null==y||null==(v=y.data)||v.points.splice(_+1,0,i),this.state=3,this.resizeHandle=_+1,this.pen.draw(this.shapes,this.activeShapeIndex)}}}}})),(0,n._)(this,"_handleMouseup",this._createControlledListener(()=>{3===this.state&&this.dispatch()})),(0,n._)(this,"_handleMouseMove",this._createControlledListener(t=>{if(this.pen){var e,i,s,h,l,a,n,o,r,d,c;if(0===this.state)this.pen.draw(this.shapes,-1,this._createShape(null==(e=this.wipPoints)?void 0:e.concat({x:t.offsetX,y:t.offsetY}))),this.canvas.style.cursor="crosshair",this.pen.drawTooltip(t.offsetX,t.offsetY,(()=>{var e,i;if((null==(e=this.wipPoints)?void 0:e.length)<(null==(i=this.options)?void 0:i.minPoint)-1)return"单击继续绘制";{let e=this.measurer.isPointInShapeKey({x:t.offsetX,y:t.offsetY},{type:"polygon",data:{points:this.wipPoints}},!0);return(null==e?void 0:e[0])===f.KeyPoint?"单击或双击结束绘制，Delete删除":"单击继续，双击完成，Delete删除"}})());else if(3===this.state){let e=null==(i=this.shapes)?void 0:i[this.activeShapeIndex];e&&-1!==this.resizeHandle&&(null==e||null==(h=e.data)||null==(s=h.points)?void 0:s[this.resizeHandle])&&(e.data.points[this.resizeHandle].x=t.offsetX,e.data.points[this.resizeHandle].y=t.offsetY,this.pen.draw(this.shapes,this.activeShapeIndex),this.canvas.style.cursor="move")}else if(2===this.state){let e=this.measurer.isPointInPath({x:t.offsetX,y:t.offsetY},this.shapes);this.shapes.length<this.options.editableMaxSize&&0===e.length?(this.pen.drawTooltip(t.offsetX,t.offsetY,"单击绘制起点"),this.canvas.style.cursor="crosshair"):e.length>0?(this.canvas.style.cursor="pointer",this.pen.drawTooltip(t.offsetX,t.offsetY,"单击面可选中并编辑，删除")):this.shapes.length>=this.options.editableMaxSize&&(this.canvas.style.cursor="not-allowed",this.pen.drawTooltip(t.offsetX,t.offsetY,`\u{7ED8}\u{5236}\u{6570}\u{91CF}\u{5DF2}\u{8FBE}\u{4E0A}\u{9650}${this.options.editableMaxSize}\u{4E2A}\u{FF0C}\u{4E0D}\u{80FD}\u{7EE7}\u{7EED}\u{7ED8}\u{5236}`))}else if(1===this.state){let e=null==(l=this.shapes)?void 0:l[this.activeShapeIndex];if(e){this.pen.draw(this.shapes,this.activeShapeIndex);let i=this.measurer.isPointInShapeKey({x:t.offsetX,y:t.offsetY},e);(null==i?void 0:i[0])===f.KeyPoint?(this.canvas.style.cursor="pointer",this.pen.drawActive(this.shapes,this.activeShapeIndex,i[1]),this.pen.drawTooltip(t.offsetX,t.offsetY,`\u{62D6}\u{62FD}\u{8282}\u{70B9}\u{8C03}\u{6574}\u{4F4D}\u{7F6E}${(null==e||null==(d=e.data)||null==(r=d.points)?void 0:r.length)>(null==(c=this.options)?void 0:c.minPoint)?"，右键删除":""}`)):(null==i?void 0:i[0])===f.CenterPoint&&(null==e||null==(n=e.data)||null==(a=n.points)?void 0:a.length)<(null==(o=this.options)?void 0:o.maxPoint)?(this.canvas.style.cursor="pointer",this.pen.drawTooltip(t.offsetX,t.offsetY,"单击在该位置添加节点")):this.canvas.style.cursor="default"}else this.canvas.style.cursor="default"}else this.canvas.style.cursor="default"}})),(0,n._)(this,"_addPoint",t=>{var e,i,s,h;if(this.wipPoints.length>0){let e=this.wipPoints[this.wipPoints.length-1];(Math.abs(e.x-t.x)>3||Math.abs(e.y-t.y)>3)&&this.wipPoints.push(t)}else this.wipPoints.push(t);this.pen&&(this.pen.draw(this.shapes,-1,this._createShape(null==(i=this.wipPoints)?void 0:i.concat(t))),this.pen.drawTooltip(t.x,t.y,(null==(s=this.wipPoints)?void 0:s.length)>=(null==(h=this.options)?void 0:h.minPoint)?"单击继续，双击完成，Delete删除":"单击继续绘制")),this.wipPoints.length>=(null==(e=this.options)?void 0:e.maxPoint)&&this._complete()}),(0,n._)(this,"_handleClick",this._createControlledListener(t=>{if(this.pen)if(3!==this.state&&4!==this.state){var e,i,s;if(0===this.state){if(this.wipPoints.length>=(null==(e=this.options)?void 0:e.minPoint)){let e=this.measurer.isPointInShapeKey({x:t.offsetX,y:t.offsetY},{type:"polygon",data:{points:this.wipPoints}},!0);if((null==e?void 0:e[0])===f.KeyPoint&&0===e[1])return void this._complete()}this._addPoint({x:t.offsetX,y:t.offsetY})}else{let e=this.measurer.isPointInPath({x:t.offsetX,y:t.offsetY},this.shapes);e.length>0?(2===this.state||1===this.state)&&this.select(e[0]):(2===this.state||1===this.state)&&this.options.editableMaxSize>(null==(i=this.shapes)?void 0:i.length)?(this._addPoint({x:t.offsetX,y:t.offsetY}),this.state=0):1===this.state&&this.options.editableMaxSize<=(null==(s=this.shapes)?void 0:s.length)&&(this.select(-1),this.state=2)}}else 3===this.state&&(this.state=1)})),(0,n._)(this,"_handleDblclick",this._createControlledListener(()=>{if(0===this.state){var t;this.wipPoints.length>=(null==(t=this.options)?void 0:t.minPoint)&&this._complete()}})),"edit"===this.options.mode&&(t.addEventListener("mousemove",this._handleMouseMove,!1),t.addEventListener("click",this._handleClick,!1),t.addEventListener("dblclick",this._handleDblclick,!1),t.addEventListener("mousedown",this._handleMousedown,!1),t.addEventListener("mouseup",this._handleMouseup,!1),document.addEventListener("keydown",this._handleKeydown,!1),document.addEventListener("click",this._handleDocumentClick,!1),t.addEventListener("mouseleave",this._handleMouseLeave,!1))}},circle:class extends E{constructor(...t){super(...t),(0,n._)(this,"resizeShape",(t,e,i)=>{if("circle"===t.type){let s=this.measurer.getShapeKeyPoints(t);if(4===s.length&&-1!==i){let h=t.data.rect;0===i?t.data.rect={x:h.x,y:e.y,width:h.width,height:s[2].y-e.y}:1===i?t.data.rect={x:h.x,y:h.y,width:e.x-h.x,height:h.height}:2===i?t.data.rect={x:h.x,y:h.y,width:h.width,height:e.y-h.y}:3===i&&(t.data.rect={x:e.x,y:h.y,width:s[1].x-e.x,height:h.height})}}})}}};class M{setMainOperator(t){this.operator=t,Object.keys(I).forEach(t=>{var e,i,s,h,l;if(t!==(null==(i=this.operator)||null==(e=i.options)?void 0:e.shape)){let e=I[t];this.subOperators.push(new e(null==(s=this.operator)?void 0:s.canvas,[],null==(h=this.operator)?void 0:h.operatorState,{...null==(l=this.operator)?void 0:l.options,subOperator:!0,shape:t}))}}),this.subOperators.forEach(t=>{this.operator&&(t.activeShapeIndex=this.operator.activeShapeIndex,t.shapes=this.operator.shapes)})}destroy(){this.operator&&this.operator.destroy(),this.subOperators.forEach(t=>{t.destroy()})}constructor(){(0,n._)(this,"operator",void 0),(0,n._)(this,"subOperators",[])}}let k={fillStyle:"rgba(255, 77, 82, 0.15)",strokeStyle:"#FF4D52",lineWidth:2,circleRadius:5},b={fillStyle:"rgba(255, 255, 255, 0.15)",strokeStyle:"#FFFFFF",lineWidth:2,circleRadius:5},L={fillStyle:"rgba(255, 161, 46, 0.15)",strokeStyle:"#FFA12E",lineWidth:2,circleRadius:5},X={editableMaxSize:1,minPoint:3,maxPoint:10,mode:"default",axis:{width:1920,height:1080}};function Y(t){let e={...X,...t},{className:i,style:s,width:h,height:n,children:o}=e,r=a.useRef(null),{ref:d}=function(t){let e=a.useRef(null),i=(null==t?void 0:t.mode)==="edit",s={...i?k:b,...t.shapeStyle},h={...i?L:k,...t.activeShapeStyle},l=t.axis,{width:n,height:o,minPoint:r,maxPoint:d,editableMaxSize:c,value:u=[],onChange:p,selectedIndex:v=-1,onSelect:y,mode:f,shape:x="polygon"}=t,_=a.useRef(),w=a.useRef();return a.useEffect(()=>{if(e.current){let i=e.current,a="default"===f?S:"select"===f?m:"edit"===f?I[x]:null;a&&(_.current=new a(i,u,new g,{shapeStyle:s,mode:t.mode,activeShapeStyle:h,axis:l,width:n,height:o,minPoint:r,maxPoint:d,editableMaxSize:c,selectedIndex:v,shape:x,onSelect:y}).on(p),"edit"===f&&(w.current=new M,w.current.setMainOperator(_.current)))}return()=>{var t,e;null==(t=_.current)||t.destroy(),null==(e=w.current)||e.destroy()}},[f,n,o,x]),a.useEffect(()=>{var t;null==_||null==(t=_.current)||t.updateShapes(u)},[u]),a.useEffect(()=>{var t,e;v!==(null==_||null==(t=_.current)?void 0:t.activeShapeIndex)&&(null==_||null==(e=_.current)||e.select(v))},[v]),{ref:e}}(e);return(0,l.jsxs)("div",{className:i,ref:r,style:{...s,position:"relative",width:`${h}px`,height:`${n}px`},children:[(0,l.jsx)("canvas",{width:h,height:n,ref:d}),a.Children.map(o,t=>a.cloneElement(t,{style:{position:"absolute"}}))]})}let D=i.p+"static/image/test.a369ccd8.jpg";var C=i(4373);let R=function(){return(0,l.jsx)(l.Fragment,{children:(0,l.jsx)(C.ImageDraw,{src:D,children:(t,e)=>(0,l.jsx)(Y,{mode:"edit",shape:"rectangle",axis:t,width:e.width,height:e.height})})})}}}]);